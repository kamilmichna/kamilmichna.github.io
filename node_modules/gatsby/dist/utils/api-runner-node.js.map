{"version":3,"sources":["../../src/utils/api-runner-node.js"],"names":["Promise","require","_","chalk","tracer","globalTracer","reporter","getCache","apiList","createNodeId","createContentDigest","buildObjectType","buildUnionType","buildInterfaceType","buildInputObjectType","emitter","getPublicPath","getNonGatsbyCodeFrame","trackBuildError","decorateEvent","boundPluginActionCreators","doubleBind","boundActionCreators","api","plugin","actionOptions","traceId","name","keys","Object","doubleBoundActionCreators","i","length","key","boundActionCreator","args","initAPICallTracing","parentSpan","startSpan","spanName","spanArgs","defaultSpanArgs","childOf","merge","runAPI","gatsbyNode","resolve","spanOptions","pluginSpan","setTag","store","loadNodeContent","getNodes","getNode","getNodesByType","hasNodeChanged","getNodeAndSavePathDependency","getState","config","program","pathPrefix","prefixPaths","publicPath","namespacedCreateNodeId","id","tracing","cache","actions","apiFinished","alreadyDisplayed","createPageAction","createPage","warning","stripIndent","bold","possiblyCodeFrame","push","warn","join","apiCallArgs","basePath","schema","pluginOptions","fromCallback","callback","cb","err","val","finish","e","error","pluginName","version","result","then","res","apisRunningById","Map","apisRunningByTraceId","waitingForCasacadeToFinish","module","exports","pluginSource","apiSpanArgs","apiSpan","forEach","traceTags","value","panic","plugins","flattenedPlugins","implementingPlugins","filter","nodeAPIs","includes","apiRunInstance","span","startTime","Date","toJSON","type","node","internal","contentDigest","filename","page","path","argsJson","JSON","stringify","omit","waitForCascadingActions","set","has","currentCount","get","stopQueuedApiRuns","onAPIRunComplete","actionHandler","action","payload","on","off","mapSeries","catch","panicOnBuild","results","delete","size","emit","isEmpty","instance","apisByTraceIdCount"],"mappings":"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","sourcesContent":["const Promise = require(`bluebird`)\nconst _ = require(`lodash`)\nconst chalk = require(`chalk`)\n\nconst tracer = require(`opentracing`).globalTracer()\nconst reporter = require(`gatsby-cli/lib/reporter`)\nconst getCache = require(`./get-cache`)\nconst apiList = require(`./api-node-docs`)\nconst createNodeId = require(`./create-node-id`)\nconst createContentDigest = require(`./create-content-digest`)\nconst {\n  buildObjectType,\n  buildUnionType,\n  buildInterfaceType,\n  buildInputObjectType,\n} = require(`../schema/types/type-builders`)\nconst { emitter } = require(`../redux`)\nconst getPublicPath = require(`./get-public-path`)\nconst { getNonGatsbyCodeFrame } = require(`./stack-trace-utils`)\nconst { trackBuildError, decorateEvent } = require(`gatsby-telemetry`)\n\n// Bind action creators per plugin so we can auto-add\n// metadata to actions they create.\nconst boundPluginActionCreators = {}\nconst doubleBind = (boundActionCreators, api, plugin, actionOptions) => {\n  const { traceId } = actionOptions\n  if (boundPluginActionCreators[plugin.name + api + traceId]) {\n    return boundPluginActionCreators[plugin.name + api + traceId]\n  } else {\n    const keys = Object.keys(boundActionCreators)\n    const doubleBoundActionCreators = {}\n    for (let i = 0; i < keys.length; i++) {\n      const key = keys[i]\n      const boundActionCreator = boundActionCreators[key]\n      if (typeof boundActionCreator === `function`) {\n        doubleBoundActionCreators[key] = (...args) => {\n          // Let action callers override who the plugin is. Shouldn't be\n          // used that often.\n          if (args.length === 1) {\n            boundActionCreator(args[0], plugin, actionOptions)\n          } else if (args.length === 2) {\n            boundActionCreator(args[0], args[1], actionOptions)\n          }\n        }\n      }\n    }\n    boundPluginActionCreators[\n      plugin.name + api + traceId\n    ] = doubleBoundActionCreators\n    return doubleBoundActionCreators\n  }\n}\n\nconst initAPICallTracing = parentSpan => {\n  const startSpan = (spanName, spanArgs = {}) => {\n    const defaultSpanArgs = { childOf: parentSpan }\n\n    return tracer.startSpan(spanName, _.merge(defaultSpanArgs, spanArgs))\n  }\n\n  return {\n    tracer,\n    parentSpan,\n    startSpan,\n  }\n}\n\nconst runAPI = (plugin, api, args) => {\n  const gatsbyNode = require(`${plugin.resolve}/gatsby-node`)\n  if (gatsbyNode[api]) {\n    const parentSpan = args && args.parentSpan\n    const spanOptions = parentSpan ? { childOf: parentSpan } : {}\n    const pluginSpan = tracer.startSpan(`run-plugin`, spanOptions)\n\n    pluginSpan.setTag(`api`, api)\n    pluginSpan.setTag(`plugin`, plugin.name)\n\n    const { store, emitter } = require(`../redux`)\n    const {\n      loadNodeContent,\n      getNodes,\n      getNode,\n      getNodesByType,\n      hasNodeChanged,\n      getNodeAndSavePathDependency,\n    } = require(`../db/nodes`)\n    const { boundActionCreators } = require(`../redux/actions`)\n\n    const doubleBoundActionCreators = doubleBind(\n      boundActionCreators,\n      api,\n      plugin,\n      { ...args, parentSpan: pluginSpan }\n    )\n\n    const { config, program } = store.getState()\n\n    const pathPrefix = (program.prefixPaths && config.pathPrefix) || ``\n    const publicPath = getPublicPath({ ...config, ...program }, ``)\n\n    const namespacedCreateNodeId = id => createNodeId(id, plugin.name)\n\n    const tracing = initAPICallTracing(pluginSpan)\n\n    const cache = getCache(plugin.name)\n\n    // Ideally this would be more abstracted and applied to more situations, but right now\n    // this can be potentially breaking so targeting `createPages` API and `createPage` action\n    let actions = doubleBoundActionCreators\n    let apiFinished = false\n    if (api === `createPages`) {\n      let alreadyDisplayed = false\n      const createPageAction = actions.createPage\n      // create new actions object with wrapped createPage action\n      // doubleBoundActionCreators is memoized, so we can't just\n      // reassign createPage field as this would cause this extra logic\n      // to be used in subsequent APIs and we only want to target this `createPages` call.\n      actions = {\n        ...actions,\n        createPage: (...args) => {\n          createPageAction(...args)\n          if (apiFinished && !alreadyDisplayed) {\n            const warning = [\n              reporter.stripIndent(`\n              Action ${chalk.bold(\n                `createPage`\n              )} was called outside of its expected asynchronous lifecycle ${chalk.bold(\n                `createPages`\n              )} in ${chalk.bold(plugin.name)}.\n              Ensure that you return a Promise from ${chalk.bold(\n                `createPages`\n              )} and are awaiting any asynchronous method invocations (like ${chalk.bold(\n                `graphql`\n              )} or http requests).\n              For more info and debugging tips: see ${chalk.bold(\n                `https://gatsby.dev/sync-actions`\n              )}\n            `),\n            ]\n\n            const possiblyCodeFrame = getNonGatsbyCodeFrame()\n            if (possiblyCodeFrame) {\n              warning.push(possiblyCodeFrame)\n            }\n\n            reporter.warn(warning.join(`\\n\\n`))\n            alreadyDisplayed = true\n          }\n        },\n      }\n    }\n\n    const apiCallArgs = [\n      {\n        ...args,\n        basePath: pathPrefix,\n        pathPrefix: publicPath,\n        boundActionCreators: actions,\n        actions,\n        loadNodeContent,\n        store,\n        emitter,\n        getCache,\n        getNodes,\n        getNode,\n        getNodesByType,\n        hasNodeChanged,\n        reporter,\n        getNodeAndSavePathDependency,\n        cache,\n        createNodeId: namespacedCreateNodeId,\n        createContentDigest,\n        tracing,\n        schema: {\n          buildObjectType,\n          buildUnionType,\n          buildInterfaceType,\n          buildInputObjectType,\n        },\n      },\n      plugin.pluginOptions,\n    ]\n\n    // If the plugin is using a callback use that otherwise\n    // expect a Promise to be returned.\n    if (gatsbyNode[api].length === 3) {\n      return Promise.fromCallback(callback => {\n        const cb = (err, val) => {\n          pluginSpan.finish()\n          callback(err, val)\n          apiFinished = true\n        }\n\n        try {\n          gatsbyNode[api](...apiCallArgs, cb)\n        } catch (e) {\n          trackBuildError(api, {\n            error: e,\n            pluginName: `${plugin.name}@${plugin.version}`,\n          })\n          throw e\n        }\n      })\n    } else {\n      const result = gatsbyNode[api](...apiCallArgs)\n      pluginSpan.finish()\n      return Promise.resolve(result).then(res => {\n        apiFinished = true\n        return res\n      })\n    }\n  }\n\n  return null\n}\n\nlet apisRunningById = new Map()\nlet apisRunningByTraceId = new Map()\nlet waitingForCasacadeToFinish = []\n\nmodule.exports = async (api, args = {}, pluginSource) =>\n  new Promise(resolve => {\n    const { parentSpan } = args\n    const apiSpanArgs = parentSpan ? { childOf: parentSpan } : {}\n    const apiSpan = tracer.startSpan(`run-api`, apiSpanArgs)\n\n    apiSpan.setTag(`api`, api)\n    _.forEach(args.traceTags, (value, key) => {\n      apiSpan.setTag(key, value)\n    })\n\n    // Check that the API is documented.\n    // \"FAKE_API_CALL\" is used when code needs to trigger something\n    // to happen once the the API queue is empty. Ideally of course\n    // we'd have an API (returning a promise) for that. But this\n    // works nicely in the meantime.\n    if (!apiList[api] && api !== `FAKE_API_CALL`) {\n      reporter.panic(`api: \"${api}\" is not a valid Gatsby api`)\n    }\n\n    const { store } = require(`../redux`)\n    const plugins = store.getState().flattenedPlugins\n\n    // Get the list of plugins that implement this API.\n    // Also: Break infinite loops. Sometimes a plugin will implement an API and\n    // call an action which will trigger the same API being called.\n    // `onCreatePage` is the only example right now. In these cases, we should\n    // avoid calling the originating plugin again.\n    const implementingPlugins = plugins.filter(\n      plugin => plugin.nodeAPIs.includes(api) && plugin.name !== pluginSource\n    )\n\n    const apiRunInstance = {\n      api,\n      args,\n      pluginSource,\n      resolve,\n      span: apiSpan,\n      startTime: new Date().toJSON(),\n      traceId: args.traceId,\n    }\n\n    // Generate IDs for api runs. Most IDs we generate from the args\n    // but some API calls can have very large argument objects so we\n    // have special ways of generating IDs for those to avoid stringifying\n    // large objects.\n    let id\n    if (api === `setFieldsOnGraphQLNodeType`) {\n      id = `${api}${apiRunInstance.startTime}${args.type.name}${args.traceId}`\n    } else if (api === `onCreateNode`) {\n      id = `${api}${apiRunInstance.startTime}${\n        args.node.internal.contentDigest\n      }${args.traceId}`\n    } else if (api === `preprocessSource`) {\n      id = `${api}${apiRunInstance.startTime}${args.filename}${args.traceId}`\n    } else if (api === `onCreatePage`) {\n      id = `${api}${apiRunInstance.startTime}${args.page.path}${args.traceId}`\n    } else {\n      // When tracing is turned on, the `args` object will have a\n      // `parentSpan` field that can be quite large. So we omit it\n      // before calling stringify\n      const argsJson = JSON.stringify(_.omit(args, `parentSpan`))\n      id = `${api}|${apiRunInstance.startTime}|${\n        apiRunInstance.traceId\n      }|${argsJson}`\n    }\n    apiRunInstance.id = id\n\n    if (args.waitForCascadingActions) {\n      waitingForCasacadeToFinish.push(apiRunInstance)\n    }\n\n    apisRunningById.set(apiRunInstance.id, apiRunInstance)\n    if (apisRunningByTraceId.has(apiRunInstance.traceId)) {\n      const currentCount = apisRunningByTraceId.get(apiRunInstance.traceId)\n      apisRunningByTraceId.set(apiRunInstance.traceId, currentCount + 1)\n    } else {\n      apisRunningByTraceId.set(apiRunInstance.traceId, 1)\n    }\n\n    let stopQueuedApiRuns = false\n    let onAPIRunComplete = null\n    if (api === `onCreatePage`) {\n      const path = args.page.path\n      const actionHandler = action => {\n        if (action.payload.path === path) {\n          stopQueuedApiRuns = true\n        }\n      }\n      emitter.on(`DELETE_PAGE`, actionHandler)\n      onAPIRunComplete = () => {\n        emitter.off(`DELETE_PAGE`, actionHandler)\n      }\n    }\n\n    Promise.mapSeries(implementingPlugins, plugin => {\n      if (stopQueuedApiRuns) {\n        return null\n      }\n\n      let pluginName =\n        plugin.name === `default-site-plugin`\n          ? `gatsby-node.js`\n          : `Plugin ${plugin.name}`\n\n      return new Promise(resolve => {\n        resolve(runAPI(plugin, api, { ...args, parentSpan: apiSpan }))\n      }).catch(err => {\n        decorateEvent(`BUILD_PANIC`, {\n          pluginName: `${plugin.name}@${plugin.version}`,\n        })\n        reporter.panicOnBuild(`${pluginName} returned an error`, err)\n        return null\n      })\n    }).then(results => {\n      if (onAPIRunComplete) {\n        onAPIRunComplete()\n      }\n      // Remove runner instance\n      apisRunningById.delete(apiRunInstance.id)\n      const currentCount = apisRunningByTraceId.get(apiRunInstance.traceId)\n      apisRunningByTraceId.set(apiRunInstance.traceId, currentCount - 1)\n\n      if (apisRunningById.size === 0) {\n        const { emitter } = require(`../redux`)\n        emitter.emit(`API_RUNNING_QUEUE_EMPTY`)\n      }\n\n      // Filter empty results\n      apiRunInstance.results = results.filter(result => !_.isEmpty(result))\n\n      // Filter out empty responses and return if the\n      // api caller isn't waiting for cascading actions to finish.\n      if (!args.waitForCascadingActions) {\n        apiSpan.finish()\n        resolve(apiRunInstance.results)\n      }\n\n      // Check if any of our waiters are done.\n      waitingForCasacadeToFinish = waitingForCasacadeToFinish.filter(\n        instance => {\n          // If none of its trace IDs are running, it's done.\n          const apisByTraceIdCount = apisRunningByTraceId.get(instance.traceId)\n          if (apisByTraceIdCount === 0) {\n            instance.span.finish()\n            instance.resolve(instance.results)\n            return false\n          } else {\n            return true\n          }\n        }\n      )\n      return\n    })\n  })\n"],"file":"api-runner-node.js"}